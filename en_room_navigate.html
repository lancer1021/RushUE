<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rush UE Room Navigate</title>

  <!-- Bootstrap + Icons + Fonts -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">

  <!-- Firebase v8 (compat) for your DB -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Leaflet for modal map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to bottom, #fbd1dc, #fff);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      position: relative;
    }

    /* Blobs */
    .animated-bg,
    .animated-bg2 {
      position: fixed;
      z-index: 0;
      border-radius: 50%;
      opacity: 0.3;
      filter: blur(80px);
    }

    .animated-bg {
      top: -100px;
      left: -100px;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, #ffdde1, #fbd1dc);
      animation: float 10s ease-in-out infinite;
    }

    .animated-bg2 {
      bottom: -120px;
      right: -120px;
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, #ffc2d1, #f8b5bd);
      animation: float2 12s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0) translateX(0)
      }

      50% {
        transform: translateY(20px) translateX(10px)
      }
    }

    @keyframes float2 {

      0%,
      100% {
        transform: translateY(0) translateX(0)
      }

      50% {
        transform: translateY(-15px) translateX(-20px)
      }
    }

    /* Header */
    .header-container {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 2;
      border-radius: 0 0 15px 15px;
    }

    .header-container img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    .header-title {
      font-weight: 600;
      font-size: 1.4rem;
      color: #dc3545;
    }

    /* Content */
    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 15px;
      position: relative;
      z-index: 1;
    }

    h2 {
      font-weight: 600;
      font-size: 1.3rem;
      margin-bottom: 15px;
    }

    select,
    input {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 2px solid #f2cfd5;
      border-radius: 8px;
      margin-bottom: 15px;
      outline: none;
    }

    select:focus,
    input:focus {
      border-color: #dc3545;
      box-shadow: 0 0 6px rgba(220, 53, 69, 0.3);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
    }

    th,
    td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #f2cfd5;
    }

    th {
      background: #fddde6;
      font-weight: 600;
    }

    tr:hover {
      background: #ffe6eb;
      cursor: pointer;
    }

    /* Footer */
    footer {
      background-color: #dc3545;
      color: white;
      font-size: 0.85rem;
      text-align: center;
      padding: 10px;
      margin-top: auto;
    }

    /* Modal map */
    #modalMapWrap {
      display: none;
    }

    #modalMap {
      height: 320px;
      width: 100%;
      border-radius: 8px;
    }

    .walker {
      width: 14px;
      height: 14px;
      background: #2563eb;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.35);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-title {
        font-size: 1.2rem;
      }

      .header-container img {
        width: 45px;
        height: 45px;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      td {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border: none;
        border-bottom: 1px solid #eee;
      }

      td:last-child {
        border-bottom: none;
      }

      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #dc3545;
      }

      #modalMap {
        height: 260px;
      }
    }
  </style>
</head>

<body>

  <!-- Animated Background Blobs -->
  <div class="animated-bg"></div>
  <div class="animated-bg2"></div>

  <!-- Header -->
  <div class="header-container">
    <a href="student.html"><img src="images/rushuelogo.jpg" alt="UE Logo"></a>
    <h2 class="header-title">Room Navigation</h2>
  </div>

  <!-- Main Content -->
  <div class="container">
    <h2>Select Building</h2>
    <select id="buildingSelect">
      <option value="EN">Engineering (EN)</option>
      <option value="TYK">Tan Yan Kee (TYK)</option>
      <option value="LCT">Lucio Tan Building (LCT)</option>
      <option value="UEC_MAIN">Main Campus (UEC_MAIN)</option>
    </select>
    <input type="text" id="search" placeholder="Search room (e.g. EN-401, student_affairs_office)...">
    <table id="roomTable">
      <thead>
        <tr>
          <th>Room</th>
          <th>Type</th>
          <th>Floor</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Room Details Modal -->
  <div class="modal fade" id="roomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Room Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Room:</strong> <span id="modalRoom"></span></p>

          <!-- Hidden when showing a map -->
          <p id="modalTypeWrap"><strong>Type:</strong> <span id="modalType"></span></p>
          <p id="modalFloorWrap"><strong>Floor:</strong> <span id="modalFloor"></span></p>

          <p><strong>Description:</strong></p>
          <p id="modalDescription" class="mb-3"></p>

          <!-- Map -->
          <div id="modalMapWrap" class="mt-2">
            <p class="mb-2"><strong>Walking Path:</strong> <span id="pathSubtitle"></span></p>
            <div id="modalMap"></div>
            <small class="text-muted d-block mt-1">The blue dot animates along your path.</small>
          </div>

          <div id="mapError" class="alert alert-warning mt-2 d-none">
            Couldnâ€™t load the campus path map. Confirm that
            <code>Ue_G (5).geojson</code> and <code>Ue_G_paths.geojson</code> are in the same folder, and labels match.
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 University of the East | Rush UE</p>
  </footer>

  <!-- App Logic (Firebase + Table + Mapping + Routing) -->
<script type="module">
  /* ---------------- Firebase (v9 via ESM) ---------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAO-rovSC2xK4ZUV9pD3ixKViQl9x4xzNk",
    authDomain: "rushue-234bc.firebaseapp.com",
    databaseURL: "https://rushue-234bc-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rushue-234bc",
    storageBucket: "rushue-234bc.appspot.com",
    messagingSenderId: "574730836644",
    appId: "1:574730836644:web:ff7c9e9eae7fc498e4a431"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getDatabase(app);

  // Ensure we have auth (rules require auth != null). Enable Anonymous Sign-in in Firebase Console.
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      try { await signInAnonymously(auth); } catch (e) { console.warn('Anon sign-in failed (check console setting).', e); }
    }
  });

  /* ---------- CLICK LOGGER: writes to /click_events ---------- */
  const VALID_BUILDINGS = new Set(['EN','TYK','LCT','UEC_MAIN']);
  function normBuilding(code){
    const s = String(code||'').trim().toUpperCase().replace(/\s+/g,'_');
    if (s === 'UEC' || s === 'UECMAIN' || s === 'MAIN' || s === 'UEC_MAIN') return 'UEC_MAIN';
    return VALID_BUILDINGS.has(s) ? s : 'EN';
  }
  async function logClick({building, room, target}){
    try{
      if (!auth.currentUser) { try{ await signInAnonymously(auth); }catch{} }
      const now  = new Date();
      const row = {
        building : normBuilding(building),                     // must be EN|TYK|LCT|UEC_MAIN
        room     : String(room||'(unknown)'),
        target   : String(target||'(unknown)'),
        date     : now.toISOString().slice(0,10),              // YYYY-MM-DD
        ts_num   : now.getTime()                               // number
      };
      await push(ref(db, 'click_events'), row);
    }catch(e){
      // Do not interrupt UX if logging fails
      console.warn('click_events push failed:', e?.message || e);
    }
  }

  /* ---------- ROOM NAME â†’ TARGET NODE MAPPING (includes pe_office â†’ Gym) ---------- */
  const ROOM_TO_TARGET = {
    gymnasium: 'Gym',
    'admission office': 'Admission Building',
    admission_office: 'Admission Building',
    campus_chapel: 'Chapel',
    pe_office: 'Gym',

    comptroller_office: 'Admission Building',
    'comptroller office': 'Admission Building',

    medical_dental_clinic: 'Medical Dental Clinic',
    'medical dental clinic': 'Medical Dental Clinic',
    med_dental: 'Medical Dental Clinic',

    registrar: "Registrar's Office",
    "registrar's office": "Registrar's Office",
    student_affairs_office: 'Student Affairs Office',
    canteen_santino: 'Canteen',
    hrm_mock_building: 'HRM Mockup Building',

    lucio_tan_building: 'Lucio Tan Building',
    lct: 'Lucio Tan Building',

    tyk: 'TYK 1st Elevator',
    'tan yan kee': 'TYK 1st Elevator',
    'tyk 1st elevator': 'TYK 1st Elevator',
    'tyk first elevator': 'TYK 1st Elevator',
    'tyk second elevator': 'TYK 2nd Elevator',
    en_right: 'Engineering Building Right Side Entrance'
  };

  /* ---------- Aliases to match labels in your GeoJSON ---------- */
  const ALIASES = {
    GATE: ['Gate', 'Main Gate', 'Front Gate', 'UE Gate'],

    EN_RIGHT: [
      'Engineering Building Right Side Entrance',
      'Engineering Building Right Entrance',
      'EN Right Entrance', 'Engineering Right Side Entrance'
    ],

    TYK: ['Tan Yan Kee', 'TYK', 'TYK Building', 'Tan Yan Kee Building'],
    TYK_ELEV_1: ['TYK 1st Elevator', 'Tyk First Elevator', 'TYK First Elevator'],
    TYK_ELEV_2: ['TYK 2nd Elevator', 'Tyk Second Elevator', 'TYK Second Elevator'],

    LCT: ['Lucio Tan', 'Lucio Tan Building', 'LCT', 'LCT Building'],
    UEC_MAIN: ['UEC Main', 'UEC Main Building', 'Main Campus', 'Main Building', 'UEC_MAIN'],

    GYM: ['Gym', 'Gymnasium'],
    ADMISSION: ['Admission Building', 'Admission Office', 'Admissions', 'admission_office'],
    CHAPEL: ['Chapel', 'Campus Chapel'],
    CANTEEN: ['Canteen', 'Canteen Santino', 'canteen_santino'],
    REGISTRAR: ["Registrar's Office", 'Registrar'],
    SAO: ['Student Affairs Office', 'SAO'],
    HRM: ['HRM Mockup Building', 'hrm_mock_building'],
    MED_DENTAL: ['Medical Dental Clinic', 'medical dental clinic', 'medical_dental_clinic']
  };

  /* ---------- Small utils ---------- */
  const norm = s => String(s || '').trim().toLowerCase();
  const slug = s => norm(s).replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
  const includesAny = (name, arr) => arr.some(a => norm(name).includes(norm(a)));

  /* ---------- Build the path graph from Ue_G_paths.geojson ---------- */
  let GRAPH = null, ALL_NODE_NAMES = [];

  async function ensureGraphReady() {
    if (GRAPH) return GRAPH;
    const res = await fetch('Ue_G_paths.geojson', { cache: 'no-store' });
    if (!res.ok) throw new Error('Cannot load Ue_G_paths.geojson');
    const data = await res.json();

    const adjDir = new Map();   // directed
    const edges = [];
    const nodes = new Set();

    for (const f of (data.features || [])) {
      const p = f.properties || {};
      const from = (p.from || p.From || p.start || '').toString().trim();
      const to = (p.to || p.To || p.end || '').toString().trim();
      if (!from || !to) continue;
      nodes.add(from); nodes.add(to);
      if (!adjDir.has(from)) adjDir.set(from, []);
      adjDir.get(from).push({ to, feature: f });
      edges.push([from, to, f]);
    }

    ALL_NODE_NAMES = Array.from(nodes);

    GRAPH = {
      edges, adjDir, nodes,
      getAdjUndir() {
        if (this.adjUndir) return this.adjUndir;
        const m = new Map();
        const add = (a, b, f) => { if (!m.has(a)) m.set(a, []); m.get(a).push({ to: b, feature: f }); };
        for (const [a, b, f] of edges) { add(a, b, f); add(b, a, f); }
        this.adjUndir = m;
        return m;
      }
    };
    return GRAPH;
  }

  function resolveNode(label) {
    const q = norm(label);
    let hit = ALL_NODE_NAMES.find(n => norm(n) === q) ||
              ALL_NODE_NAMES.find(n => norm(n).includes(q) || q.includes(norm(n)));
    if (hit) return hit;

    for (const arr of Object.values(ALIASES)) {
      if (arr.some(a => q.includes(norm(a)))) {
        hit = ALL_NODE_NAMES.find(n => arr.some(a => norm(n).includes(norm(a))));
        if (hit) return hit;
      }
    }
    hit = ALL_NODE_NAMES.find(n => q.split(/\s+/).every(tok => norm(n).includes(tok)));
    return hit || null;
  }

  function bfsRoute(graph, start, goal, undirected = false) {
    const adj = undirected ? graph.getAdjUndir() : graph.adjDir;
    const q = [start];
    const parent = new Map([[start, null]]);
    let reached = null;

    while (q.length) {
      const cur = q.shift();
      if (cur === goal) { reached = cur; break; }
      for (const e of (adj.get(cur) || [])) {
        if (!parent.has(e.to)) {
          parent.set(e.to, { prev: cur, feature: e.feature });
          q.push(e.to);
        }
      }
    }
    if (!reached) return null;

    const chain = [];
    let cur = reached;
    while (parent.get(cur)) {
      chain.push(parent.get(cur).feature);
      cur = parent.get(cur).prev;
    }
    return chain.reverse();
  }

  async function findRouteFromGate(toLabel) {
    await ensureGraphReady();
    const start = resolveNode('Gate');
    const goal  = resolveNode(toLabel);
    if (!start || !goal) return null;

    let chain = bfsRoute(GRAPH, start, goal, false);
    if (!chain) chain = bfsRoute(GRAPH, start, goal, true);
    if (!chain) return null;

    const coords = [];
    for (const f of chain) {
      const g = f.geometry || {};
      if (g.type === 'LineString') coords.push(...g.coordinates);
      else if (g.type === 'MultiLineString') g.coordinates.forEach(arr => coords.push(...arr));
    }
    return { features: chain, coordinates: coords, start, goal };
  }

  // modal leaflet map
  let modalMap = null, buildingsLayer = null, routeLayer = null, progressLine = null, walker = null, animRAF = null;

  function ensureModalMap() {
    if (modalMap) return modalMap;
    const el = document.getElementById('modalMap');
    modalMap = L.map(el, { zoomControl: true }).setView([14.6575, 120.983], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22 }).addTo(modalMap);
    setTimeout(() => modalMap.invalidateSize(), 0);
    return modalMap;
  }
  async function addBuildingsOverlay() {
    try {
      const r = await fetch(encodeURI('Ue_G (5).geojson'), { cache: 'no-store' });
      if (!r.ok) return;
      const data = await r.json();
      buildingsLayer = L.geoJSON(data, { style: { color: '#9ca3af', weight: 1, fillOpacity: 0.2 } }).addTo(modalMap);
    } catch {}
  }
  function clearRouteLayers() {
    if (routeLayer) { modalMap.removeLayer(routeLayer); routeLayer = null; }
    if (progressLine) { modalMap.removeLayer(progressLine); progressLine = null; }
    if (walker) { modalMap.removeLayer(walker); walker = null; }
  }
  function destroyModalMap() {
    if (animRAF) { cancelAnimationFrame(animRAF); animRAF = null; }
    clearRouteLayers();
    if (buildingsLayer) { modalMap.removeLayer(buildingsLayer); buildingsLayer = null; }
    if (modalMap) { modalMap.remove(); modalMap = null; }
  }

  function drawAndAnimate(coords) {
    clearRouteLayers();
    const merged = { type: 'Feature', geometry: { type: 'LineString', coordinates: coords } };
    routeLayer = L.geoJSON(merged, { style: { color: '#60a5fa', weight: 5, opacity: 0.25 } }).addTo(modalMap);
    modalMap.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });

    const latlngs = coords.map(c => L.latLng(c[1], c[0]));
    progressLine = L.polyline([latlngs[0]], { color: '#2563eb', weight: 6 }).addTo(modalMap);
    walker = L.marker(latlngs[0], { icon: L.divIcon({ className: 'walker' }), zIndexOffset: 1000 }).addTo(modalMap);

    const SPEED = 2.2 * 1.15; // m/s
    const segs = [];
    for (let i = 0; i < latlngs.length - 1; i++) {
      const a = latlngs[i], b = latlngs[i + 1];
      const d = modalMap.distance(a, b);
      segs.push({ a, b, dur: d / SPEED * 1000 });
    }
    let i = 0, t0 = performance.now();
    const step = (now) => {
      const s = segs[i]; if (!s) { animRAF = null; return; }
      const t = Math.min(1, (now - t0) / s.dur);
      const cur = L.latLng(s.a.lat + (s.b.lat - s.a.lat) * t, s.a.lng + (s.b.lng - s.a.lng) * t);
      walker.setLatLng(cur);
      const pts = progressLine.getLatLngs();
      if (!pts.length || modalMap.distance(pts[pts.length - 1], cur) > 0.5) { pts.push(cur); progressLine.setLatLngs(pts); }
      if (t >= 1) { i++; t0 = now; const pts2 = progressLine.getLatLngs(); pts2.push(s.b); progressLine.setLatLngs(pts2); walker.setLatLng(s.b); }
      animRAF = requestAnimationFrame(step);
    };
    animRAF = requestAnimationFrame(step);
  }

  // pick a target room where the roomnum data and selected building is going
  function pickTargetForRoom(roomNum, roomData, selectedBuilding) {
    const cands = [
      String(roomNum || ''),
      norm(roomNum),
      slug(roomNum),
      String(roomData?.name || ''),
      norm(roomData?.name || ''),
      slug(roomData?.name || '')
    ];
    for (const c of cands) {
      if (ROOM_TO_TARGET[c]) return ROOM_TO_TARGET[c];
    }
    switch (selectedBuilding) {
      case 'EN': return 'Engineering Building Right Side Entrance';
      case 'TYK': return 'TYK 1st Elevator';
      case 'LCT': return 'Lucio Tan Building';
      case 'UEC_MAIN': return 'UEC Main';
      default: return null;
    }
  }

  /* ---------- Wire a row to open modal & show route + LOG CLICK ---------- */
  function attachRoomRowHandler(row, roomNum, roomData) {
    const modalEl = document.getElementById('roomModal');
    const modalRoom = document.getElementById('modalRoom');
    const modalType = document.getElementById('modalType');
    const modalFloor = document.getElementById('modalFloor');
    const modalDescription = document.getElementById('modalDescription');
    const modalTypeWrap = document.getElementById('modalTypeWrap');
    const modalFloorWrap = document.getElementById('modalFloorWrap');
    const modalMapWrap = document.getElementById('modalMapWrap');
    const pathSubtitle = document.getElementById('pathSubtitle');
    const mapError = document.getElementById('mapError');
    const buildingSelect = document.getElementById('buildingSelect');

    row.addEventListener('click', async () => {
      const selectedBuilding = buildingSelect?.value || 'EN';
      const target = pickTargetForRoom(roomNum, roomData, selectedBuilding);

      // ðŸ”´ LOG THE CLICK HERE
      logClick({
        building: selectedBuilding,
        room: roomNum,
        target: target || roomData?.description || 'room-row'
      });

      // Fill modal details
      modalRoom.textContent = roomNum;
      modalType.textContent = roomData?.type || '';
      modalFloor.textContent = roomData?.floor ?? '';
      modalDescription.textContent = roomData?.description || 'No description available';

      // Decide target and toggle map visibility
      const showMap = Boolean(target);
      modalTypeWrap.style.display = showMap ? 'none' : '';
      modalFloorWrap.style.display = showMap ? 'none' : '';
      modalMapWrap.style.display = showMap ? 'block' : 'none';
      pathSubtitle.textContent = showMap ? `Gate â†’ ${target}` : '';
      mapError.classList.add('d-none');

      // Open modal
      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();

      const onShown = async () => {
        if (!showMap) return;
        try {
          ensureModalMap();
          await addBuildingsOverlay();
          await ensureGraphReady();
          const route = await findRouteFromGate(target);
          if (!route || !route.coordinates?.length) {
            mapError.classList.remove('d-none');
            return;
          }
          mapError.classList.add('d-none');
          drawAndAnimate(route.coordinates);
        } catch (e) {
          console.error(e);
          mapError.classList.remove('d-none');
        }
      };

      const onHidden = () => {
        destroyModalMap();
        modalEl.removeEventListener('shown.bs.modal', onShown);
        modalEl.removeEventListener('hidden.bs.modal', onHidden);
      };

      modalEl.addEventListener('shown.bs.modal', onShown);
      modalEl.addEventListener('hidden.bs.modal', onHidden);
    });
  }

  /* ---------- Table Load / Filter (from your Firebase) ---------- */
  const buildingSelect = document.getElementById('buildingSelect');
  const search = document.getElementById('search');
  const tableBody = document.querySelector('#roomTable tbody');

  async function loadRooms(buildingCode) {
    tableBody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
    const buildingRef = ref(db, buildingCode);
    const snapshot = await get(buildingRef);

    if (!snapshot.exists()) {
      tableBody.innerHTML = "<tr><td colspan='4'>No data available</td></tr>";
      return;
    }

    const building = snapshot.val();
    let allRooms = {};

    if (building.floors) {
      for (const floorKey in building.floors) {
        const floor = building.floors[floorKey];
        if (floor.rooms) {
          for (const roomKey in floor.rooms) {
            allRooms[roomKey] = { ...floor.rooms[roomKey], floor: floorKey, name: roomKey };
          }
        }
      }
    }

    if (building.special_rooms) {
      for (const specialKey in building.special_rooms) {
        allRooms[specialKey] = { ...building.special_rooms[specialKey], floor: "Special", name: specialKey };
      }
    }

    displayRooms(allRooms);
    search.oninput = () => filterRooms(allRooms, search.value);
  }

  function displayRooms(rooms) {
    tableBody.innerHTML = '';
    Object.entries(rooms).forEach(([roomNum, roomData]) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td data-label="Room">${roomNum}</td>
        <td data-label="Type">${roomData.type || ''}</td>
        <td data-label="Floor">${roomData.floor}</td>
        <td data-label="Description">${roomData.description || ''}</td>
      `;
      attachRoomRowHandler(row, roomNum, roomData); // logs click + opens modal
      tableBody.appendChild(row);
    });
  }

  function filterRooms(rooms, query) {
    const filtered = {};
    const q = (query || '').toLowerCase();
    Object.entries(rooms).forEach(([roomNum, roomData]) => {
      const match =
        roomNum.toLowerCase().includes(q) ||
        (roomData.remarks && roomData.remarks.toLowerCase().includes(q)) ||
        (roomData.type && roomData.type.toLowerCase().includes(q)) ||
        (roomData.description && roomData.description.toLowerCase().includes(q)) ||
        (roomData.floor && String(roomData.floor).toLowerCase().includes(q));
      if (match) filtered[roomNum] = roomData;
    });
    displayRooms(filtered);
  }

  // init
  loadRooms(buildingSelect.value);
  buildingSelect.addEventListener('change', () => loadRooms(buildingSelect.value));
</script>


  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>